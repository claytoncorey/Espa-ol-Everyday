// This service uses the Web Audio API for robust sound playback that respects browser autoplay policies.

// Store context and buffers globally within the module
let audioContext: AudioContext | null = null;
let successChimeBuffer: AudioBuffer | null = null;
let completionFanfareBuffer: AudioBuffer | null = null;
let isInitializing = false; // Prevent race conditions during initialization

// Base64 encoded chime sound
const successChimeB64 = 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA';

// Base64 encoded fanfare sound
const completionFanfareB64 = 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAU8AAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA//uQZAUsAAAACAAADSAAAAAMD9gBAAAAAAD/7UEgAABgBgN/8A8AAA8AAAAAABIAAAAAAIVo+gBkAACY8ADeQGAAAIiBwAAAACAo/8A/8BAAD/6AAA';

/**
 * Decodes a base64 string into an ArrayBuffer.
 * @param {string} base64 The base64 encoded string.
 * @returns {ArrayBuffer}
 */
const base64ToArrayBuffer = (base64: string) => {
    const binaryString = window.atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
};

/**
 * Fetches and decodes audio from a data URL into an AudioBuffer.
 * @param {AudioContext} context The audio context to use for decoding.
 * @param {string} dataUrl The data URL of the audio file.
 * @returns {Promise<AudioBuffer>}
 */
const loadAndDecodeAudio = async (context: AudioContext, dataUrl: string): Promise<AudioBuffer> => {
    const base64Data = dataUrl.split(',')[1];
    if (!base64Data) {
        throw new Error("Invalid Base64 audio data URL");
    }
    const arrayBuffer = base64ToArrayBuffer(base64Data);
    return await context.decodeAudioData(arrayBuffer);
};

/**
 * Initializes the global AudioContext.
 * This must be called following a user interaction (e.g., a click event).
 * It is safe to call this function multiple times.
 */
export const initAudio = async () => {
    if (audioContext && audioContext.state === 'running') {
        return; // Already initialized and running.
    }
    
    // Prevent multiple concurrent initialization attempts.
    if (isInitializing) {
        return;
    }

    try {
        if (!audioContext) {
            isInitializing = true;
            audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();

            // Decode the audio files into buffers on the first initialization.
            const successPromise = loadAndDecodeAudio(audioContext, successChimeB64);
            const fanfarePromise = loadAndDecodeAudio(audioContext, completionFanfareB64);
            [successChimeBuffer, completionFanfareBuffer] = await Promise.all([successPromise, fanfarePromise]);
        }
        
        // If the context is suspended, it needs a user gesture to resume.
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }
    } catch (error) {
        console.error("Failed to initialize or decode audio:", error);
        // Reset state on failure so an attempt can be made again.
        audioContext = null; 
    } finally {
        isInitializing = false;
    }
};

/**
 * Plays a pre-loaded AudioBuffer.
 * @param {AudioBuffer | null} buffer The buffer to play.
 */
const playSound = (buffer: AudioBuffer | null) => {
    if (!audioContext || !buffer || audioContext.state !== 'running') {
        console.warn('Audio context not ready or buffer not loaded. User may need to interact with the page first.');
        return;
    }
    try {
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
    } catch (error) {
        console.error("Error playing sound:", error);
    }
};

/**
 * Plays the success chime sound.
 */
export const playSuccessChime = () => {
    playSound(successChimeBuffer);
};

/**
 * Plays the completion fanfare sound.
 */
export const playCompletionFanfare = () => {
    playSound(completionFanfareBuffer);
};
